<script type="module">
  import anyDateParser from 'https://cdn.jsdelivr.net/npm/any-date-parser@2.1.0/dist/index.mjs';
</script>

<script>
  const input = `Join us in Berlin
    Get ready to experience the latest innovations and announcements from Google I/O, with fresh updates across Android, AI, web, cloud, and more.

    At this in-person developer event you can join presentations, demos, Q&As and other interactive sessions to learn about our latest tools and technologies. Experts from across Google will share new insights and best practices to help you innovate, boost productivity, and simplify workflows.

    June 25, 8:30am to 7:00pm CET, at Wilhelm Studios`;
  (async () => {
    const event = await parseEventDetails(input);
    const startDate = parse(
      [
        event.start_time,
        event.start_date,
        event.start_year,
        event.timezone
      ].join(' ')
    );
    const endDate = parse(
      [event.end_time, event.end_date, event.end_year, event.timezone].join(' ')
    );
    event.dates = format(startDate) + '/' + format(endDate);

    const googleCalendarUrl = createGoogleCalendarUrl(event);
  })();

  function parse(dateString) {
    const parsed = anyDateParser.attempt(dateString);
    return new Date(
      parsed.year,
      parsed.month - 1,
      parsed.day,
      parsed.hour,
      parsed.minute
    );
  }

  function format(date) {
    let month = '' + (date.getMonth() + 1);
    let day = '' + date.getDate();
    const year = date.getFullYear();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    return [year, month, day, 'T', hours, minutes, seconds].join('');
  }

  function createGoogleCalendarUrl(eventDetails) {
    let googleCalendarUrl =
      'https://calendar.google.com/calendar/render?action=TEMPLATE';

    if (eventDetails.title) {
      googleCalendarUrl += '&text=' + encodeURIComponent(eventDetails.title);
    }
    if (eventDetails.dates) {
      googleCalendarUrl += '&dates=' + encodeURIComponent(eventDetails.dates);
    }
    if (eventDetails.description) {
      googleCalendarUrl +=
        '&details=' + encodeURIComponent(eventDetails.description);
    }

    if (eventDetails.location) {
      googleCalendarUrl +=
        '&location=' + encodeURIComponent(eventDetails.location);
    }
    return googleCalendarUrl;
  }

  async function parseEventDetails(text) {
    const params = await LanguageModel.params();
    const session = await LanguageModel.create({
      temperature: 1.0,
      topK: 1.0
    });

    let prompt = `
    The following text describes an event. Extract "title", "start_time", "start_date", "start_year", "end_time", "end_date", "end_year", "description", "timezone" and "location" of the event. Return only JSON as result.

    * If no year is provided, use the current year ${new Date().getFullYear()}.
    * If no timezone is provided, leave it empty.
    * Do not convert the start time or end time

    Here is the text:

     ${text}`;

    const result = await session.prompt(prompt);
    return JSON.parse(fixCommonJSONMistakes(result), null, '  ');
  }

  function generateCalendarPrompt(text) {
    const today = new Date().toISOString().substring(0, 10);
    return (
      'Your job is to create a calendar entry from a snippet of ' +
      'text that I will present to you later. You have to return a JSON array ' +
      'of calendar entries. Each calendar entry is a JSON object with the ' +
      'following fields:\n' +
      '- start_date: The start date of the event in YYYY-MM-DD format\n' +
      '- start_time: The start time of the event in HH:MM format (assume 24h ' +
      'format)\n' +
      '- end_date: The end date of the event in YYYY-MM-DD format\n' +
      '- end_time: The end time of the event in HH:MM format (assume 24h ' +
      'format)\n' +
      '- title: The title of the event\n' +
      '- location: The location of the event\n' +
      '- description: The description of the event\n\n' +
      'The description of the event should contain all information that may be ' +
      'useful. Here are some examples:\n' +
      'Today is ${today}. If no year is specified, assume that the the event ' +
      `should start on the first date on or after ${today}.\n` +
      'If you find two time assume that one specifies the start and the other ' +
      'one the end of an event. If you find only one time, assume that the ' +
      'event lasts for 60 minutes.\n' +
      'You are given the following information:\n' +
      '```\n' +
      text
        .split('\n')
        .map((line) => line.trim())
        .join('\n')
        .replace(/\n{2,}/g, '\n\n') +
      '\n' +
      '```\n' +
      'If the presented information does not contain something that can be ' +
      'used to create a calendar entry, you should return an empty array.'
    );
  }

  function openGoogleCalendarEvent(eventDetails) {
    let googleCalendarUrl =
      'https://calendar.google.com/calendar/render?action=TEMPLATE';

    if (eventDetails.title) {
      googleCalendarUrl += '&text=' + encodeURIComponent(eventDetails.title);
    }
    if (eventDetails.dates) {
      googleCalendarUrl += '&dates=' + encodeURIComponent(eventDetails.dates);
    }
    if (eventDetails.description) {
      googleCalendarUrl +=
        '&details=' + encodeURIComponent(eventDetails.description);
    }

    if (eventDetails.location) {
      googleCalendarUrl +=
        '&location=' + encodeURIComponent(eventDetails.location);
    }

    chrome.tabs.create({ url: googleCalendarUrl });
  }

  function addCommaBetweenQuotes(str) {
    return str.replace(/"([^"]*)"\s+"([^"]*)"/g, '"$1", "$2"');
  }

  function extractTextBetweenCurlyBraces(str) {
    if (str[0] === '[') return str;
    const firstBraceIndex = str.indexOf('{');
    const lastBraceIndex = str.lastIndexOf('}');

    if (firstBraceIndex === -1 || lastBraceIndex === -1) {
      return null; // No curly braces found
    }

    return str.substring(firstBraceIndex, lastBraceIndex + 1);
  }

  function curlyToBrackets(str) {
    // Check if the input is a string
    if (typeof str !== 'string') {
      return 'Input must be a string.';
    }

    // Use a regular expression to match curly braces with quoted strings inside
    return str.replace(/\{("([^"]*)"(?:,\s*)?)*\}/g, function (match) {
      // Remove curly braces and replace with brackets
      return '[' + match.slice(1, -1) + ']';
    });
  }

  function fixCommonJSONMistakes(str) {
    str = str.trim();
    str = curlyToBrackets(str);
    str = extractTextBetweenCurlyBraces(str);
    str = addCommaBetweenQuotes(str);
    return str;
  }
</script>
